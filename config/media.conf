##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# http://wiki.nginx.org/Pitfalls
# http://wiki.nginx.org/QuickStart
# http://wiki.nginx.org/Configuration
#
# Generally, you will want to move this file somewhere, and start with a clean
# file but keep this around for reference. Or just disable in sites-enabled.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##


# Default server configuration
#
server {
    listen 80;
    listen [::]:80;

    server_name _;
    root /var/www/html;

    client_max_body_size 100M;

    location ~* ^/(api|socket.io) {
        # Websocket configuration
        proxy_http_version 1.1;
        proxy_set_header Connection "upgrade";
        proxy_set_header Upgrade $http_upgrade;

        proxy_set_header HOST $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://media-service:3000;
    }

    location ~* ^/([documents|images|videos]+)/([a-f0-9-]+)/([a-f0-9-]+)\.([a-z0-9]+)$ {
        rewrite ^/([documents|images|videos]+)/([a-f0-9-]+)/([a-f0-9-]+)\.([a-z0-9]+)$ /$2/$1/$3.$4 break;
        proxy_set_header HOST $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://minio:9000;
    }

    location ~* ^/([images]+)/([a-f0-9-]+)/([a-f0-9-]+)_([\d]+)x([\d]+)\.([a-z0-9]+)$ {
        rewrite ^/([images]+)/([a-f0-9-]+)/([a-f0-9-]+)_([\d]+)x([\d]+)\.([a-z0-9]+)$ /$2/$1/$3_$4x$5.$6 break;
        proxy_set_header HOST $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://minio:9000;
        proxy_intercept_errors on;
        recursive_error_pages on;
        error_page 404 = @rewrite_proxy_image;
    }

    location @rewrite_proxy_image {
        rewrite ^/([a-f0-9-]+)/([images]+)/([a-f0-9-]+)_([\d]+)x([\d]+)\.([a-z0-9]+)$ /$2/$1/$3_$4x$5.$6 break;
        proxy_set_header HOST $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://media-service:3000;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root /var/www/html;
    }
}


# Redirect server configuration
#
# server {
#     listen 80;
#     listen [::]:80;

#     server_name localhost;
#     return 301 https://$host$request_uri;
# }


# Https server configuration
#
# server {
# 	listen 443 ssl;
# 	listen [::]:443 ssl;

# 	ssl on;
# 	ssl_certificate /etc/ssl/certs/test-file.crt;
# 	ssl_certificate_key /etc/ssl/privates/test-file.key;
# 	#
# 	# Note: You should disable gzip for SSL traffic.
# 	# See: https://bugs.debian.org/773332
# 	#
# 	# Read up on ssl_ciphers to ensure a secure configuration.
# 	# See: https://bugs.debian.org/765782
# 	#
# 	# Self signed certs generated by the ssl-cert package
# 	# Don't use them in a production server!
# 	#
# 	# include snippets/snakeoil.conf;

# 	server_name localhost www.localhost;

# 	location / {
#         proxy_set_header    HOST $host;
#         proxy_set_header    X-Real-IP $remote_addr;
#         proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_pass          http://localhost:3000;
# 	}
# }


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
# server {
#     listen 80;
#     listen [::]:80;

#     server_name example.com;

#     root /var/www/example.com;
#     index index.html;

#     location / {
#             try_files $uri $uri/ =404;
#     }
# }